---
import navigation from "../../data/navigation";
import socials from "../../data/socials";
import { UI, getLocaleFromAstro } from "../../i18n/ui";

const locale = getLocaleFromAstro(Astro.currentLocale) as "en" | "es";
const base = locale === "es" ? "/es" : "";

/**
 * Normaliza un path a:
 * - empieza por /
 * - no tiene query/hash (si llegaran)
 * - con trailing slash (excepto raíz)
 */
const ensureSlash = (p: string) => {
  let path = (p ?? "/").trim();
  if (!path) path = "/";
  // elimina query/hash si vinieran
  path = path.split("#")[0].split("?")[0];
  if (!path.startsWith("/")) path = `/${path}`;
  if (path !== "/" && !path.endsWith("/")) path = `${path}/`;
  return path;
};

/**
 * Construye href absoluto por locale:
 * EN: /projects/
 * ES: /es/projects/
 * Evita /es/es/... si item.href ya viniera con /es
 */
const abs = (raw: string) => {
  const path = ensureSlash(raw);

  // Si ya viene con /es, primero “limpiamos” a path base EN
  const clean = path === "/es/" ? "/" : path.replace(/^\/es\//, "/");

  // Ahora aplicamos base del locale actual
  if (base) {
    return clean === "/" ? "/es/" : `/es${clean}`;
  }
  return clean;
};

/** Para el switch: devuelve el path EN equivalente (sin /es) */
const toEnPath = (pathname: string) => {
  const p = ensureSlash(pathname);
  if (p === "/es/") return "/";
  return p.replace(/^\/es\//, "/");
};

/** Para el switch: toma un path EN y lo convierte a ES */
const toEsPath = (pathnameEn: string) => {
  const p = ensureSlash(pathnameEn);
  return p === "/" ? "/es/" : `/es${p}`;
};

const currentPath = ensureSlash(Astro.url.pathname);

// nav locale-aware
const navLocalized = navigation.map((item) => ({
  href: abs(item.href),
  label: UI[locale].nav[item.key],
}));

const homeHref = abs("/");

// switch locale conservando ruta
const switchTo: "en" | "es" = locale === "es" ? "en" : "es";

// Convertimos la ruta actual a “EN base”
const enPath = toEnPath(currentPath);

// Generamos href del idioma destino
const switchHref = switchTo === "es" ? toEsPath(enPath) : enPath;

/** Comparación active consistente con trailingSlash */
const norm = (p: string) => ensureSlash(p); // ya deja todo uniforme
const isActive = (href: string) => norm(currentPath) === norm(href);
---

<header class="site-header" role="banner">
  <div class="container">
    <a class="brand" href={homeHref} aria-label="Go to home">
      <span class="brand-name">Andrés Castrillón</span>
      <span class="brand-subtitle">Software Engineer · XR Developer · Aviation Maintenance Engineer</span>
    </a>

    <nav class="nav" aria-label="Primary navigation">
      <ul class="nav-list" role="list">
        {navLocalized.map((item) => (
          <li>
            <a class:list={["nav-link", isActive(item.href) && "active"]} href={item.href}>
              {item.label}
            </a>
          </li>
        ))}

        <li class="lang">
          <a class="nav-link" href={switchHref} aria-label="Switch language" rel="alternate" hreflang={switchTo}>
            {switchTo === "es" ? "ES" : "EN"}
          </a>
        </li>
      </ul>
    </nav>

    <div class="socials" aria-label="Social links">
      {socials?.length ? (
        <ul class="socials-list" role="list">
          {socials.map((s) => (
            <li>
              <a
                class="social-link"
                href={s.href}
                target="_blank"
                rel="noreferrer"
                aria-label={s.label}
                title={s.label}
              >
                {s.label}
              </a>
            </li>
          ))}
        </ul>
      ) : null}
    </div>
  </div>
</header>

<style>
  /* tu CSS aquí */
  /* Layout */
  .site-header {
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}

.site-header .container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 18px;
}

/* Brand block */
.brand {
  display: grid;
  gap: 2px;
  text-decoration: none;
  min-width: 220px;
}
.brand-name {
  color: var(--text);
  font-weight: 700;
  line-height: 1.1;
}
.brand-subtitle {
  color: var(--muted);
  font-size: 12px;
  line-height: 1.25;
}

/* Nav layout (remove bullets + horizontal) */
.nav {
  flex: 1;
  display: flex;
  justify-content: center;
}

.nav-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Links */
.nav-link {
  color: var(--muted);
  text-decoration: none;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid transparent;
  transition: background 150ms ease, color 150ms ease, border-color 150ms ease;
}

.nav-link:hover {
  background: rgba(255,255,255,0.04);
  color: var(--text);
}

.nav-link.active {
  color: var(--text);
  background: rgba(88,166,255,0.12);
  border-color: rgba(88,166,255,0.25);
}

.nav-link:focus-visible {
  outline: 2px solid rgba(88,166,255,0.65);
  outline-offset: 2px;
}

/* Socials on the right */
.socials {
  min-width: 140px;
  display: flex;
  justify-content: flex-end;
}

.socials-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.social-link {
  color: var(--muted);
  text-decoration: none;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid transparent;
  transition: background 150ms ease, color 150ms ease, border-color 150ms ease;
}

.social-link:hover {
  background: rgba(255,255,255,0.04);
  color: var(--text);
}

/* Responsive: stack neatly */
@media (max-width: 860px) {
  .site-header .container {
    flex-direction: column;
    align-items: flex-start;
  }

  .nav {
    width: 100%;
    justify-content: flex-start;
  }

  .socials {
    width: 100%;
    justify-content: flex-start;
  }
</style>
