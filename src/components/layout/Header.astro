---
import navigation from "../../data/navigation";
import socials from "../../data/socials";
import { UI, getLocaleFromAstro } from "../../i18n/ui";

const locale = getLocaleFromAstro(Astro.currentLocale) as "en" | "es";
const base = locale === "es" ? "/es" : "";

/**
 * Normaliza un path a:
 * - empieza por /
 * - no tiene query/hash (si llegaran)
 * - con trailing slash (excepto raíz)
 */
const ensureSlash = (p: string) => {
  let path = (p ?? "/").trim();
  if (!path) path = "/";
  // elimina query/hash si vinieran
  path = path.split("#")[0].split("?")[0];
  if (!path.startsWith("/")) path = `/${path}`;
  if (path !== "/" && !path.endsWith("/")) path = `${path}/`;
  return path;
};

/**
 * Construye href absoluto por locale:
 * EN: /projects/
 * ES: /es/projects/
 * Evita /es/es/... si item.href ya viniera con /es
 */
const abs = (raw: string) => {
  const path = ensureSlash(raw);

  // Si ya viene con /es, primero “limpiamos” a path base EN
  const clean = path === "/es/" ? "/" : path.replace(/^\/es\//, "/");

  // Ahora aplicamos base del locale actual
  if (base) {
    return clean === "/" ? "/es/" : `/es${clean}`;
  }
  return clean;
};

/** Para el switch: devuelve el path EN equivalente (sin /es) */
const toEnPath = (pathname: string) => {
  const p = ensureSlash(pathname);
  if (p === "/es/") return "/";
  return p.replace(/^\/es\//, "/");
};

/** Para el switch: toma un path EN y lo convierte a ES */
const toEsPath = (pathnameEn: string) => {
  const p = ensureSlash(pathnameEn);
  return p === "/" ? "/es/" : `/es${p}`;
};

const currentPath = ensureSlash(Astro.url.pathname);

// nav locale-aware
const navLocalized = navigation.map((item) => ({
  href: abs(item.href),
  label: UI[locale].nav[item.key],
}));

const homeHref = abs("/");

// switch locale conservando ruta
const switchTo: "en" | "es" = locale === "es" ? "en" : "es";

// Convertimos la ruta actual a “EN base”
const enPath = toEnPath(currentPath);

// Generamos href del idioma destino
const switchHref = switchTo === "es" ? toEsPath(enPath) : enPath;

/** Comparación active consistente con trailingSlash */
const norm = (p: string) => ensureSlash(p); // ya deja todo uniforme
const isActive = (href: string) => norm(currentPath) === norm(href);
---

<header class="site-header" role="banner">
  <div class="container">
    <a class="brand" href={homeHref} aria-label="Go to home">
      <span class="brand-name">Andrés Castrillón</span>
      <span class="brand-subtitle">Software Engineer · XR Developer · Aviation Maintenance Engineer</span>
    </a>

    <nav class="nav" aria-label="Primary navigation">
      <ul class="nav-list" role="list">
        {navLocalized.map((item) => (
          <li>
            <a class:list={["nav-link", isActive(item.href) && "active"]} href={item.href}>
              {item.label}
            </a>
          </li>
        ))}

        <li class="lang">
          <a class="nav-link" href={switchHref} aria-label="Switch language" rel="alternate" hreflang={switchTo}>
            {switchTo === "es" ? "ES" : "EN"}
          </a>
        </li>
      </ul>
    </nav>

    <div class="socials" aria-label="Social links">
      {socials?.length ? (
        <ul class="socials-list" role="list">
          {socials.map((s) => (
            <li>
              <a
                class="social-link"
                href={s.href}
                target="_blank"
                rel="noreferrer"
                aria-label={s.label}
                title={s.label}
              >
                {s.label}
              </a>
            </li>
          ))}
        </ul>
      ) : null}
    </div>
  </div>
</header>

<style>
  /* tu CSS aquí */
  /* Layout */
  .site-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: white;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 14px 18px;
    display: grid;
    grid-template-columns: 1.2fr 1fr auto;
    gap: 16px;
    align-items: center;
  }

  /* Marca */
  .brand {
    display: inline-flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
    min-width: 0;
  }

  .brand-name {
    font-size: 16px;
    font-weight: 700;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .brand-subtitle {
    font-size: 12px;
    line-height: 1.2;
    opacity: 0.75;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 4px;
  }

  /* Nav */
  .nav-list {
    display: flex;
    gap: 14px;
    justify-content: center;
    align-items: center;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  .nav-link {
    display: inline-flex;
    padding: 8px 10px;
    text-decoration: none;
    color: inherit;
    border-radius: 8px;
    font-size: 14px;
    opacity: 0.85;
  }

  .nav-link:hover {
    opacity: 1;
    background: rgba(0, 0, 0, 0.04);
  }

  .nav-link.active {
    opacity: 1;
    font-weight: 600;
    background: rgba(0, 0, 0, 0.06);
  }

  /* Socials */
  .socials-list {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    align-items: center;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  .social-link {
    display: inline-flex;
    padding: 8px 10px;
    text-decoration: none;
    color: inherit;
    border-radius: 8px;
    font-size: 13px;
    opacity: 0.85;
  }

  .social-link:hover {
    opacity: 1;
    background: rgba(0, 0, 0, 0.04);
  }

  /* Responsive */
  @media (max-width: 860px) {
    .container {
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .nav-list {
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .socials-list {
      justify-content: flex-start;
      flex-wrap: wrap;
    }
  }
</style>
