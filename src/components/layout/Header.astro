---
import navigation from "../../data/navigation";
import { getRelativeLocaleUrl } from "astro:i18n";
import { UI, getLocaleFromAstro } from "../../i18n/ui";
import socials from "../../data/socials";

const locale = getLocaleFromAstro(Astro.currentLocale);

const pathname = Astro.url.pathname;
const basePath =
  locale === "es" && pathname.startsWith("/es/")
    ? pathname.slice(3)
    : locale === "es" && pathname === "/es"
      ? "/"
      : pathname;

const safeLocaleRoot = (l: string) => getRelativeLocaleUrl(l) || "/";

const urlFor = (l: "en" | "es", path: string) => {
  const clean = path === "/" ? undefined : path.replace(/^\//, "");
  const candidate = getRelativeLocaleUrl(l, clean);
  return candidate || "/";
};

const navLocalized = navigation.map((item) => {
  const href = item.href === "/" ? safeLocaleRoot(locale) : urlFor(locale, item.href);
  const label = UI[locale].nav[item.key];
  return { href, label };
});

const switchTo = locale === "es" ? "en" : "es";
const switchHref = basePath === "/" ? safeLocaleRoot(switchTo) : urlFor(switchTo, basePath);

const isActive = (href: string) => {
  const norm = (s: string) => (s.endsWith("/") && s !== "/" ? s.slice(0, -1) : s);
  return norm(Astro.url.pathname) === norm(href);
};
---

<header class="site-header" role="banner">
  <div class="container">
    <!-- Marca -->
    <a class="brand" href="/" aria-label="Go to home">
      <span class="brand-name">Andrés Castrillón</span>
      <span class="brand-subtitle">Software Engineer · XR Developer · Aviation Maintenance Engineer</span>
    </a>

    <!-- Navegación -->
<nav class="nav" aria-label="Primary navigation">
  <ul class="nav-list" role="list">
    {navLocalized.map((item) => (
      <li>
        <a class:list={["nav-link", isActive(item.href) && "active"]} href={item.href}>
          {item.label}
        </a>
      </li>
    ))}

    <li class="lang">
      <a class="nav-link" href={switchHref} aria-label="Switch language">
        {switchTo === "es" ? "ES" : "EN"}
      </a>
    </li>
  </ul>
</nav>

    <!-- Socials (opcional) -->
    <div class="socials" aria-label="Social links">
      {socials?.length ? (
        <ul class="socials-list" role="list">
          {socials.map((s) => (
            <li>
              <a
                class="social-link"
                href={s.href}
                target="_blank"
                rel="noreferrer"
                aria-label={s.label}
                title={s.label}
              >
                {s.label}
              </a>
            </li>
          ))}
        </ul>
      ) : null}
    </div>
  </div>
</header>

<style>
  /* Layout */
  .site-header {
    position: sticky;
    top: 0;
    z-index: 50;
    background: white;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  }

  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 14px 18px;
    display: grid;
    grid-template-columns: 1.2fr 1fr auto;
    gap: 16px;
    align-items: center;
  }

  /* Marca */
  .brand {
    display: inline-flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
    min-width: 0;
  }

  .brand-name {
    font-size: 16px;
    font-weight: 700;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .brand-subtitle {
    font-size: 12px;
    line-height: 1.2;
    opacity: 0.75;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 4px;
  }

  /* Nav */
  .nav-list {
    display: flex;
    gap: 14px;
    justify-content: center;
    align-items: center;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  .nav-link {
    display: inline-flex;
    padding: 8px 10px;
    text-decoration: none;
    color: inherit;
    border-radius: 8px;
    font-size: 14px;
    opacity: 0.85;
  }

  .nav-link:hover {
    opacity: 1;
    background: rgba(0, 0, 0, 0.04);
  }

  .nav-link.active {
    opacity: 1;
    font-weight: 600;
    background: rgba(0, 0, 0, 0.06);
  }

  /* Socials */
  .socials-list {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    align-items: center;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  .social-link {
    display: inline-flex;
    padding: 8px 10px;
    text-decoration: none;
    color: inherit;
    border-radius: 8px;
    font-size: 13px;
    opacity: 0.85;
  }

  .social-link:hover {
    opacity: 1;
    background: rgba(0, 0, 0, 0.04);
  }

  /* Responsive */
  @media (max-width: 860px) {
    .container {
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .nav-list {
      justify-content: flex-start;
      flex-wrap: wrap;
    }

    .socials-list {
      justify-content: flex-start;
      flex-wrap: wrap;
    }
  }
</style>
